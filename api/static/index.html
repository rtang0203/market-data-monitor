<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Exchange Funding Rates</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #0a0e17;
            color: #e0e0e0;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: #ffffff;
        }

        .last-updated {
            font-size: 0.9rem;
            color: #888;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: #888;
        }

        .error {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: #ff6b6b;
        }

        /* Exchange Tabs */
        .exchange-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            border: 2px solid #1a1f2e;
            border-radius: 8px;
            background-color: #151923;
            color: #888;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tab:hover {
            background-color: #1a1f2e;
            color: #e0e0e0;
        }

        .tab.active {
            color: #ffffff;
            background-color: #1a1f2e;
        }

        /* Exchange-specific border colors for active tabs */
        .tab.active[data-exchange="binance_lighter"] {
            border-color: #f0b90b;
            box-shadow: 0 0 10px rgba(240, 185, 11, 0.3);
        }

        .tab.active[data-exchange="bybit_lighter"] {
            border-color: #ff9500;
            box-shadow: 0 0 10px rgba(255, 149, 0, 0.3);
        }

        .tab.active[data-exchange="hyperliquid"],
        .tab.active[data-exchange="hyperliquid_lighter"] {
            border-color: #8b5cf6;
            box-shadow: 0 0 10px rgba(139, 92, 246, 0.3);
        }

        .tab.active[data-exchange="lighter"] {
            border-color: #3b82f6;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.3);
        }

        .tables-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 20px;
        }

        @media (max-width: 968px) {
            .tables-container {
                grid-template-columns: 1fr;
            }

            .exchange-tabs {
                overflow-x: auto;
                justify-content: flex-start;
                padding-bottom: 10px;
            }

            .tab {
                flex-shrink: 0;
            }
        }

        .table-wrapper {
            background-color: #151923;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .table-header {
            padding: 20px;
            font-size: 1.3rem;
            font-weight: 600;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .table-header.long {
            background-color: #1a4d2e;
            color: #4ade80;
        }

        .table-header.short {
            background-color: #4d1a1a;
            color: #f87171;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background-color: #1a1f2e;
            padding: 15px 20px;
            text-align: left;
            font-weight: 600;
            font-size: 0.85rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        th.center {
            text-align: center;
        }

        td {
            padding: 15px 20px;
            border-top: 1px solid #1a1f2e;
            font-size: 0.95rem;
        }

        td.center {
            text-align: center;
        }

        tr:hover {
            background-color: #1a1f2e;
        }

        .rank {
            font-weight: 600;
            color: #666;
        }

        .symbol {
            font-weight: 600;
            font-size: 1.05rem;
        }

        .funding-rate {
            font-weight: 600;
            font-size: 1.05rem;
        }

        .funding-rate.negative {
            color: #4ade80;
        }

        .funding-rate.positive {
            color: #f87171;
        }

        .data-status {
            font-size: 0.85rem;
            color: #888;
        }

        .data-status.complete {
            color: #4ade80;
        }

        .footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: #666;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Multi-Exchange Funding Rates</h1>
            <div class="last-updated" id="lastUpdated">Loading...</div>
        </header>

        <!-- Exchange Tabs -->
        <div class="exchange-tabs">
            <button class="tab active" data-exchange="hyperliquid">Hyperliquid (Direct)</button>
            <button class="tab" data-exchange="binance_lighter">Binance</button>
            <button class="tab" data-exchange="bybit_lighter">Bybit</button>
            <button class="tab" data-exchange="hyperliquid_lighter">Hyperliquid (Lighter)</button>
            <button class="tab" data-exchange="lighter">Lighter</button>
        </div>

        <div id="content">
            <div class="loading">Loading funding rates...</div>
        </div>
    </div>

    <script>
        let lastFetchTime = null;
        let currentExchange = 'hyperliquid';  // Default to direct Hyperliquid
        let allExchangeData = {};  // Cache all exchange data

        // Exchange display names
        const exchangeNames = {
            'hyperliquid': 'Hyperliquid (Direct)',
            'binance_lighter': 'Binance',
            'bybit_lighter': 'Bybit',
            'hyperliquid_lighter': 'Hyperliquid (Lighter API)',
            'lighter': 'Lighter'
        };

        // Format funding rate as percentage
        function formatFundingRate(rate) {
            const percentage = (rate * 100).toFixed(3);
            return `${percentage}%`;
        }

        // Format data status
        function formatDataStatus(dataPoints) {
            return dataPoints >= 100 ? 'Complete' : `${dataPoints} pts`;
        }

        // Calculate time ago
        function getTimeAgo(timestamp) {
            const now = new Date();
            const then = new Date(timestamp);
            const diffMs = now - then;
            const diffMins = Math.floor(diffMs / 60000);

            if (diffMins < 1) return 'Just now';
            if (diffMins === 1) return '1 minute ago';
            if (diffMins < 60) return `${diffMins} minutes ago`;

            const diffHours = Math.floor(diffMins / 60);
            if (diffHours === 1) return '1 hour ago';
            return `${diffHours} hours ago`;
        }

        // Update last updated display
        function updateLastUpdatedDisplay() {
            if (lastFetchTime) {
                const timeAgo = getTimeAgo(lastFetchTime);
                const exchangeName = exchangeNames[currentExchange] || currentExchange;
                document.getElementById('lastUpdated').textContent = `${exchangeName} - Last updated: ${timeAgo}`;
            }
        }

        // Create table HTML
        function createTable(data, type) {
            const isLong = type === 'long';
            const headerClass = isLong ? 'long' : 'short';
            const headerText = isLong ? 'Top 10 Long Opportunities' : 'Top 10 Short Opportunities';

            if (!data || data.length === 0) {
                return `
                    <div class="table-wrapper">
                        <div class="table-header ${headerClass}">${headerText}</div>
                        <div class="error" style="padding: 20px;">No data available yet. Data collection in progress...</div>
                    </div>
                `;
            }

            let html = `
                <div class="table-wrapper">
                    <div class="table-header ${headerClass}">${headerText}</div>
                    <table>
                        <thead>
                            <tr>
                                <th class="center">Rank</th>
                                <th>Symbol</th>
                                <th>Funding 3D Avg</th>
                                <th class="center">Data Status</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            data.forEach((item, index) => {
                const fundingClass = item.avg_funding_rate < 0 ? 'negative' : 'positive';
                const statusClass = item.data_points >= 100 ? 'complete' : '';

                html += `
                    <tr>
                        <td class="center rank">${index + 1}</td>
                        <td class="symbol">${item.symbol}</td>
                        <td class="funding-rate ${fundingClass}">${formatFundingRate(item.avg_funding_rate)}</td>
                        <td class="center data-status ${statusClass}">${formatDataStatus(item.data_points)}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            return html;
        }

        // Render current exchange data
        function renderExchangeData() {
            const contentDiv = document.getElementById('content');
            const exchangeData = allExchangeData[currentExchange];

            if (!exchangeData) {
                contentDiv.innerHTML = '<div class="loading">No data available for this exchange yet.</div>';
                return;
            }

            contentDiv.innerHTML = `
                <div class="tables-container">
                    ${createTable(exchangeData.long_opportunities, 'long')}
                    ${createTable(exchangeData.short_opportunities, 'short')}
                </div>
            `;

            updateLastUpdatedDisplay();
        }

        // Tab switching logic
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // Update active tab
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                // Update current exchange and render
                currentExchange = tab.dataset.exchange;
                renderExchangeData();
            });
        });

        // Fetch and display data
        async function fetchFundingRates() {
            try {
                const response = await fetch('/api/funding-rates-by-exchange');

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                lastFetchTime = data.last_updated;

                // Cache all exchange data
                allExchangeData = data;

                // Render current exchange
                renderExchangeData();

            } catch (error) {
                console.error('Error fetching funding rates:', error);
                document.getElementById('content').innerHTML = `
                    <div class="error">Failed to load funding rates: ${error.message}</div>
                `;
            }
        }

        // Initial load
        fetchFundingRates();

        // Refresh every 5 minutes
        setInterval(fetchFundingRates, 5 * 60 * 1000);

        // Update "time ago" display every minute
        setInterval(updateLastUpdatedDisplay, 60 * 1000);
    </script>
</body>
</html>
