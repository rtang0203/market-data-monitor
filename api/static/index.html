<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hyperliquid Funding Rates</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #0a0e17;
            color: #e0e0e0;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: #ffffff;
        }

        .last-updated {
            font-size: 0.9rem;
            color: #888;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: #888;
        }

        .error {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: #ff6b6b;
        }

        .tables-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 20px;
        }

        @media (max-width: 968px) {
            .tables-container {
                grid-template-columns: 1fr;
            }
        }

        .table-wrapper {
            background-color: #151923;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .table-header {
            padding: 20px;
            font-size: 1.3rem;
            font-weight: 600;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .table-header.long {
            background-color: #1a4d2e;
            color: #4ade80;
        }

        .table-header.short {
            background-color: #4d1a1a;
            color: #f87171;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background-color: #1a1f2e;
            padding: 15px 20px;
            text-align: left;
            font-weight: 600;
            font-size: 0.85rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        th.center {
            text-align: center;
        }

        td {
            padding: 15px 20px;
            border-top: 1px solid #1a1f2e;
            font-size: 0.95rem;
        }

        td.center {
            text-align: center;
        }

        tr:hover {
            background-color: #1a1f2e;
        }

        .rank {
            font-weight: 600;
            color: #666;
        }

        .symbol {
            font-weight: 600;
            font-size: 1.05rem;
        }

        .funding-rate {
            font-weight: 600;
            font-size: 1.05rem;
        }

        .funding-rate.negative {
            color: #4ade80;
        }

        .funding-rate.positive {
            color: #f87171;
        }

        .data-status {
            font-size: 0.85rem;
            color: #888;
        }

        .data-status.complete {
            color: #4ade80;
        }

        .footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: #666;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Hyperliquid Funding Rates</h1>
            <div class="last-updated" id="lastUpdated">Loading...</div>
        </header>

        <div id="content">
            <div class="loading">Loading funding rates...</div>
        </div>
    </div>

    <script>
        let lastFetchTime = null;

        // Format funding rate as percentage
        function formatFundingRate(rate) {
            const percentage = (rate * 100).toFixed(3);
            return `${percentage}%`;
        }

        // Format data status
        function formatDataStatus(dataPoints) {
            return dataPoints >= 100 ? 'Complete' : `${dataPoints} pts`;
        }

        // Calculate time ago
        function getTimeAgo(timestamp) {
            const now = new Date();
            const then = new Date(timestamp);
            const diffMs = now - then;
            const diffMins = Math.floor(diffMs / 60000);

            if (diffMins < 1) return 'Just now';
            if (diffMins === 1) return '1 minute ago';
            if (diffMins < 60) return `${diffMins} minutes ago`;

            const diffHours = Math.floor(diffMins / 60);
            if (diffHours === 1) return '1 hour ago';
            return `${diffHours} hours ago`;
        }

        // Update last updated display
        function updateLastUpdatedDisplay() {
            if (lastFetchTime) {
                const timeAgo = getTimeAgo(lastFetchTime);
                document.getElementById('lastUpdated').textContent = `Last updated: ${timeAgo}`;
            }
        }

        // Create table HTML
        function createTable(data, type) {
            const isLong = type === 'long';
            const headerClass = isLong ? 'long' : 'short';
            const headerText = isLong ? 'Top 10 Long Opportunities' : 'Top 10 Short Opportunities';

            let html = `
                <div class="table-wrapper">
                    <div class="table-header ${headerClass}">${headerText}</div>
                    <table>
                        <thead>
                            <tr>
                                <th class="center">Rank</th>
                                <th>Coin</th>
                                <th>Funding 3D Avg</th>
                                <th class="center">Data Status</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            data.forEach((item, index) => {
                const fundingClass = item.funding_3d_avg < 0 ? 'negative' : 'positive';
                const statusClass = item.data_points >= 100 ? 'complete' : '';

                html += `
                    <tr>
                        <td class="center rank">${index + 1}</td>
                        <td class="symbol">${item.symbol}</td>
                        <td class="funding-rate ${fundingClass}">${formatFundingRate(item.funding_3d_avg)}</td>
                        <td class="center data-status ${statusClass}">${formatDataStatus(item.data_points)}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            return html;
        }

        // Fetch and display data
        async function fetchFundingRates() {
            try {
                const response = await fetch('/api/funding-rates');

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                lastFetchTime = data.updated_at;

                const contentDiv = document.getElementById('content');

                if (data.top_10_long.length === 0 && data.top_10_short.length === 0) {
                    contentDiv.innerHTML = '<div class="error">No funding rate data available yet. Please wait for data collection to begin.</div>';
                    return;
                }

                contentDiv.innerHTML = `
                    <div class="tables-container">
                        ${createTable(data.top_10_long, 'long')}
                        ${createTable(data.top_10_short, 'short')}
                    </div>
                `;

                updateLastUpdatedDisplay();

            } catch (error) {
                console.error('Error fetching funding rates:', error);
                document.getElementById('content').innerHTML = `
                    <div class="error">Failed to load funding rates: ${error.message}</div>
                `;
            }
        }

        // Initial load
        fetchFundingRates();

        // Refresh every 5 minutes
        setInterval(fetchFundingRates, 5 * 60 * 1000);

        // Update "time ago" display every minute
        setInterval(updateLastUpdatedDisplay, 60 * 1000);
    </script>
</body>
</html>
